{% extends 'users_app/base.html' %}
{% load humanize tz %}


{% block title %}User Dashboard{% endblock %}

{% block content %}


<div class="bg-gray-100 dark:bg-gray-900 min-h-screen p-6 transition-colors duration-300">

	<!-- Top Bar -->
	<div class="flex justify-between items-center mb-6">
		<!-- Logout -->
		<form method="post" action="{% url 'logout' %}">
			{% csrf_token %}
			<button type="submit"
				class="px-4 py-2 bg-red-500 text-white font-medium rounded-lg shadow hover:bg-red-600 transition">
				Logout
			</button>
		</form>

		<!-- Dark Mode Toggle -->
		<button onclick="toggleDarkMode()"
			class="px-4 py-2 bg-gray-200 dark:bg-gray-700 dark:text-white rounded-lg shadow hover:bg-gray-300 dark:hover:bg-gray-600 transition">
			🌙 Toggle Dark Mode
		</button>
	</div>
	<div>
		<h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-8">User Road Ratings</h1>
		<h3 class="text-gray-800 dark:text-gray-100 mb-4">Hi, there. You have rated {{ user_conv_count }} roads. Click
			on a card to view details</h3>
		{% include 'includes/paginator.html' %}
		<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
			{% for user_conversation in page_obj %}
			<div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md hover:shadow-xl border border-gray-200 dark:border-gray-700 transition transform hover:-translate-y-1 cursor-pointer flex"
				onclick="openModal(
						'{{ user_conversation.fk_road_id.id }}',
						'{{ user_conversation.fk_road_id.road_name }}',
						'{{ user_conversation.fk_road_id.rating }}',
						'{{ user_conversation.fk_road_id.comment|escapejs }}',
						'{{ user_conversation.fk_road_id.created_at }}',
						'{{ user_conversation.fk_road_id.gps_coordinates }}'
					)">

				<!-- Left Column: Stars -->
				<div class="flex flex-col items-center justify-start mr-4">
					{% for i in ""|center:user_conversation.fk_road_id.rating %}
					<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" class="bi bi-star-fill 
							{% if user_conversation.fk_road_id.rating >= 4 %}
								text-yellow-500 dark:text-yellow-400
							{% elif user_conversation.fk_road_id.rating == 3 %}
								text-yellow-400 dark:text-yellow-300
							{% else %}
								text-yellow-300 dark:text-yellow-200
							{% endif %}
							text-yellow-400 dark:text-yellow-300 
							mb-1" viewBox="0 0 16 16">
						<path
							d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z" />
					</svg>
					{% endfor %}
				</div>

				<!-- Right Column: Info -->
				<div class="flex flex-col flex-1">
					<h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-1">
						{{ user_conversation.fk_road_id.road_name }}
					</h3>

					<p class="text-gray-600 dark:text-gray-300 mb-2 truncate">
						{% if user_conversation.fk_road_id.comment %}
							{{ user_conversation.fk_road_id.comment|slice:":50" }}{% if user_conversation.fk_road_id.comment|length > 50 %}…{% endif %}
						{% else %}
							<em class="text-gray-400 italic">No comments provided.</em>
						{% endif %}
					</p>

					<p class="text-sm text-gray-500 dark:text-gray-400">
						Rated at: {{ user_conversation.fk_road_id.created_at|localtime|naturaltime }}
					</p>
				</div>
			</div>

			{% empty %}
			<p class="col-span-full text-center text-gray-500 dark:text-gray-400">No road ratings available.</p>
			{% endfor %}
		</div>
		{% include 'includes/paginator.html' %}
	</div>

	<!-- Modal -->
	<div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
		onclick="closeModal(event)">
		<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-11/12 md:w-2/3 lg:w-1/2 p-6 relative max-h-[80vh] overflow-y-auto transition-colors duration-300"
			onclick="event.stopPropagation()">

			<!-- Close Button -->
			<button onclick="closeModal()"
				class="absolute top-2 right-2 text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-gray-100 text-xl font-bold">&times;</button>

			<!-- Modal Content -->
			<h2 id="modalTitle" class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2"></h2>
			<p id="modalRating" class="flex items-center text-yellow-500 dark:text-yellow-400 font-semibold mb-1"></p>
			<p id="modalDate" class="text-sm text-gray-500 dark:text-gray-400 mb-3"></p>
			<a id="modalMap" href="#" target="_blank"
				class="text-blue-600 dark:text-blue-400 hover:underline mb-4 inline-block"></a>

			<!-- Pics Grid -->
			<!-- <div id="modalPics" class="grid grid-cols-2 gap-4"></div> -->
			<!-- Slideshow Container -->
			<!-- Accordion Layout -->
			<div class="space-y-2">
				<!-- Comment Accordion -->
				<div class="border rounded-lg overflow-hidden">
					<button onclick="toggleAccordion('commentSection')"
						class="w-full flex justify-between items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-semibold">
						Comments
						<span class="accordion-icon">+</span>
					</button>
					<div id="commentSection" class="accordion-content hidden bg-gray-50 dark:bg-gray-800 p-4">
						<p id="modalCommentAccordion" class="text-gray-600 dark:text-gray-300">
						<p id="modalComment" class="text-gray-600 dark:text-gray-300 mb-2"></p>
						</p>
					</div>
				</div>
				<!-- Images Accordion -->
				<div class="border rounded-lg overflow-hidden">
					<button onclick="toggleAccordion('images')"
						class="w-full flex justify-between items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-semibold">
						Images
						<span class="accordion-icon">+</span>
					</button>
					<div id="images" class="accordion-content hidden bg-gray-50 dark:bg-gray-800 p-4 relative">
						<!-- Navigation buttons -->
						<button id="prevBtn"
							class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 z-10">
							&#10094;
						</button>
						<button id="nextBtn"
							class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 z-10">
							&#10095;
						</button>
						<div id="modalPics"
							class="relative w-full h-96 overflow-hidden rounded-lg shadow-lg bg-gray-100 dark:bg-gray-700">
						</div>
					</div>
				</div>

				<!-- Videos Accordion -->
				<div class="border rounded-lg overflow-hidden">
					<button onclick="toggleAccordion('videos')"
						class="w-full flex justify-between items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-semibold">
						Videos
						<span class="accordion-icon">+</span>
					</button>
					<div id="videos" class="accordion-content hidden bg-gray-50 dark:bg-gray-800 p-4">
						<div id="gridVideos" class="grid grid-cols-2 gap-2"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Scripts -->
	<script>
		// Modal functions
		document.addEventListener("DOMContentLoaded", () => {
			const el = document.getElementById("localizedDate");
			const dt = new Date(el.dataset.dt); // parse ISO string
			const now = new Date();
			const diffMs = now - dt;
			const diffSec = Math.round(diffMs / 1000);

			let value, unit;

			if (diffSec < 60) {
				value = -diffSec;
				unit = "second";
			} else if (diffSec < 3600) {
				value = -Math.round(diffSec / 60);
				unit = "minute";
			} else if (diffSec < 86400) {
				value = -Math.round(diffSec / 3600);
				unit = "hour";
			} else if (diffSec < 604800) {
				value = -Math.round(diffSec / 86400);
				unit = "day";
			} else {
				// fallback: show full date for older posts
				el.textContent = dt.toLocaleString();
				return;
			}

			const rtf = new Intl.RelativeTimeFormat(undefined, { numeric: "auto" });
			el.textContent = rtf.format(value, unit);
		});

		let slideIndex = 0;
		let slideInterval;

		function renderSlideshow(pics) {
			const container = document.getElementById("modalPics");
			const videoContainer = document.getElementById("gridVideos");
			videoContainer.innerHTML = ""; // reset
			container.innerHTML = ""; // reset
			if (!pics.length) {
				videoContainer.innerHTML = "<p class='text-gray-400 italic p-4'>No videos uploaded.</p>";
				container.innerHTML = "<p class='text-gray-400 italic p-4'>No images uploaded.</p>";
			}
			let videos = 0;
			let images = 0;

			pics.forEach((url, idx) => {
				let element;
				// check file type by extension				
				if (url.match(/\.(mp4|webm|ogg|mkv)$/i) || url.split('?')[0].match(/\.(mp4|webm|ogg|mkv)$/i)) {
					videos++;
					element = document.createElement("video");
					element.src = url;
					element.muted = true;
					element.controls = true;    // prevent autoplay issues
					element.loop = true;       // optional
					element.playsInline = true;
					element.className = "rounded-lg shadow m-2 w-32 h-32";
					videoContainer.appendChild(element); // clone to videos section
				} else {
					images++;
					element = document.createElement("img");
					element.src = url;
					element.className = "absolute inset-0 w-full h-full object-cover transition-opacity duration-700";
					element.style.opacity = idx === 0 ? "1" : "0";
					container.appendChild(element);
				}
			});
			if (images === 0) {
				container.innerHTML = "<p class='text-gray-400 italic p-4'>No images uploaded.</p>";
			}

			if (videos === 0) {
				videoContainer.innerHTML = "<p class='text-gray-400 italic p-4'>No videos uploaded.</p>";
			}

			slideIndex = 0;
			startSlideshow();
		}

		function showSlide(index) {
			const slides = document.querySelectorAll("#modalPics img");
			if (!slides.length) return;

			slides.forEach((img, i) => {
				img.style.opacity = i === index ? "1" : "0";
			});
		}

		function startSlideshow() {
			clearInterval(slideInterval);
			slideInterval = setInterval(() => {
				const slides = document.querySelectorAll("#modalPics img");
				slideIndex = (slideIndex + 1) % slides.length;
				showSlide(slideIndex);
			}, 3000); // 3 seconds
		}

		// Navigation buttons
		document.getElementById("prevBtn").addEventListener("click", () => {
			const slides = document.querySelectorAll("#modalPics img");
			slideIndex = (slideIndex - 1 + slides.length) % slides.length;
			showSlide(slideIndex);
		});

		document.getElementById("nextBtn").addEventListener("click", () => {
			const slides = document.querySelectorAll("#modalPics img");
			slideIndex = (slideIndex + 1) % slides.length;
			showSlide(slideIndex);
		});

		function renderStars(rating, maxStars = 5, filledStarHtml, emptyStarHtml) {
			let starsHtml = "";
			for (let i = 1; i <= maxStars; i++) {
				starsHtml += i <= rating ? filledStarHtml : emptyStarHtml;
			}
			return starsHtml;
		}

		function openModal(roadId, name, rating, comment, date, gps) {
			const filledStar = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star-fill text-warning" viewBox="0 0 16 16">
			<path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.32-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.63.282.95l-3.523 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/>
			</svg>`;

			const emptyStar = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-star text-gray-400" viewBox="0 0 16 16">
			<path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.523-3.356c.33-.32.158-.888-.283-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.118l-4.898.696c-.441.062-.612.63-.282.95l3.523 3.356-.83 4.73z"/>
			</svg>`;
			document.getElementById('modalTitle').textContent = name;
			//document.getElementById('modalRating').textContent = "Rated: " + rating + "★";
			document.getElementById('modalRating').innerHTML = `${renderStars(rating, 5, filledStar, emptyStar)}`;
			document.getElementById('modalComment').innerHTML = comment;
			document.getElementById('modalDate').textContent = "Rated at: " + date + " UTC";

			let mapLink = document.getElementById('modalMap');
			if (gps && gps !== "None") {
				mapLink.href = generateMapLink(gps);
				mapLink.textContent = "📍 View on Map";
			} else {
				mapLink.textContent = "No GPS coordinates available";
				mapLink.href = "#";
			}

			fetch(`/get-presigned-urls/${roadId}/`)
				.then(response => response.json())
				.then(data => {
					if (data.urls && data.urls.length > 0) {
						renderSlideshow(data.urls);
						document.getElementById("prevBtn").style.display = "block";
						document.getElementById("nextBtn").style.display = "block";
					} else {
						const container = document.getElementById("modalPics");
						container.innerHTML = "<p class='text-gray-400 italic p-4'>No images uploaded.</p>";
						document.getElementById("prevBtn").style.display = "none";
						document.getElementById("nextBtn").style.display = "none";
					}
				})
				.catch(err => {
					console.error("Error loading images:", err);
					const container = document.getElementById("modalPics");
					container.innerHTML = "<p class='text-red-500 italic p-4'>Failed to load images.</p>";
					document.getElementById("prevBtn").style.display = "none";
					document.getElementById("nextBtn").style.display = "none";
				});

			document.getElementById('detailsModal').classList.remove("hidden");
			document.getElementById('detailsModal').classList.add("flex");
		}


		function closeModal() {
			document.getElementById('detailsModal').classList.add("hidden");
			document.getElementById('detailsModal').classList.remove("flex");
		}

		// Dark Mode Toggle
		function toggleDarkMode() {
			document.documentElement.classList.toggle('dark');
			// Save preference in localStorage
			if (document.documentElement.classList.contains('dark')) {
				localStorage.setItem('theme', 'dark');
			} else {
				localStorage.setItem('theme', 'light');
			}
		}

		// Load saved preference
		if (localStorage.getItem('theme') === 'dark') {
			document.documentElement.classList.add('dark');
		} else {
			document.documentElement.classList.remove('dark');
		}

		// Close modal with ESC
		document.addEventListener("keydown", function (e) {
			if (e.key === "Escape") closeModal();
		});

		function toggleAccordion(id) {
			const content = document.getElementById(id);
			const icon = content.previousElementSibling.querySelector(".accordion-icon");

			if (content.classList.contains("hidden")) {
				content.classList.remove("hidden");
				icon.textContent = "−"; // change icon to minus
			} else {
				content.classList.add("hidden");
				icon.textContent = "+"; // change back to plus
			}
		}


	</script>

</div>
{% endblock %}

</html>