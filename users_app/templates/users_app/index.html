{% load static %}
<!DOCTYPE html>
<html lang="en" class="dark">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>User Road Ratings</title>
	<script src="{% static 'users_app/index.js' %}"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		// Enable Tailwind dark mode via class strategy
		tailwind.config = {
			darkMode: 'class'
		}
	</script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 min-h-screen p-6 transition-colors duration-300">

	<!-- Top Bar -->
	<div class="flex justify-between items-center mb-6">
		<!-- Logout -->
		<form method="post" action="{% url 'logout' %}">
			{% csrf_token %}
			<button type="submit"
				class="px-4 py-2 bg-red-500 text-white font-medium rounded-lg shadow hover:bg-red-600 transition">
				Logout
			</button>
		</form>

		<!-- Dark Mode Toggle -->
		<button onclick="toggleDarkMode()"
			class="px-4 py-2 bg-gray-200 dark:bg-gray-700 dark:text-white rounded-lg shadow hover:bg-gray-300 dark:hover:bg-gray-600 transition">
			üåô Toggle Dark Mode
		</button>
	</div>

	<h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-8">User Road Ratings</h1>
	<h3 class="text-gray-800 dark:text-gray-100 mb-4">Hi, there. You have rated {{ user_conv_count }} roads. Click on a card to view details</h3>
	{% include 'includes/paginator.html' %}
		<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
			{% for user_conversation in page_obj %}
			<div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md hover:shadow-xl transition transform hover:-translate-y-1 cursor-pointer"
			onclick="openModal(
				'{{ user_conversation.fk_road_id.id }}',
				'{{ user_conversation.fk_road_id.road_name }}',
				'{{ user_conversation.fk_road_id.rating }}',
				'{{ user_conversation.fk_road_id.comment|escapejs }}',
				'{{ user_conversation.fk_road_id.created_at }}',
				'{{ user_conversation.fk_road_id.gps_coordinates }}'
			)">			

			<h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-2">
				{{ user_conversation.fk_road_id.road_name }}
			</h3>

			<p class="text-yellow-400 font-semibold mb-1">
				‚≠ê Rating: {{ user_conversation.fk_road_id.rating }}
			</p>

			<p class="text-gray-600 dark:text-gray-300 mb-2 truncate">
				<span class="font-medium">Comment:</span> {{ user_conversation.fk_road_id.comment }}
			</p>

			<p class="text-sm text-gray-500 dark:text-gray-400 mb-3">
				Rated at: {{ user_conversation.fk_road_id.created_at }}
			</p>
		</div>
		<!-- <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md hover:shadow-xl transition transform hover:-translate-y-1 cursor-pointer"
			onclick="openModal('{{ user_conversation.fk_road_id.road_name }}',
									'{{ user_conversation.fk_road_id.rating }}',
									'{{ user_conversation.fk_road_id.comment }}',
									'{{ user_conversation.fk_road_id.created_at }}',
									'{{ user_conversation.fk_road_id.gps_coordinates }}',
									[{% for pic in user_conversation.fk_road_id.roadmedia_set.all %}'{{ pic.file.url }}',{% endfor %}])">

			<h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-2">
				{{ user_conversation.fk_road_id.road_name }}
			</h3>

			<p class="text-yellow-400 font-semibold mb-1">
				‚≠ê Rating: {{ user_conversation.fk_road_id.rating }}
			</p>

			<p class="text-gray-600 dark:text-gray-300 mb-2 truncate">
				<span class="font-medium">Comment:</span> {{ user_conversation.fk_road_id.comment }}
			</p>

			<p class="text-sm text-gray-500 dark:text-gray-400 mb-3">
				Rated at: {{ user_conversation.fk_road_id.created_at }}
			</p>
		</div> -->
		{% empty %}
		<p class="col-span-full text-center text-gray-500 dark:text-gray-400">No road ratings available.</p>
		{% endfor %}
	</div>

	{% include 'includes/paginator.html' %}

	<!-- Modal -->
	<div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeModal(event)">
		<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-11/12 md:w-2/3 lg:w-1/2 p-6 relative transition-colors duration-300" onclick="event.stopPropagation()">

			<!-- Close Button -->
			<button onclick="closeModal()"
				class="absolute top-2 right-2 text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-gray-100 text-xl font-bold">&times;</button>

			<!-- Modal Content -->
			<h2 id="modalTitle" class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2"></h2>
			<p id="modalRating" class="text-yellow-400 font-semibold mb-1"></p>
			<p id="modalComment" class="text-gray-600 dark:text-gray-300 mb-2"></p>
			<p id="modalDate" class="text-sm text-gray-500 dark:text-gray-400 mb-3"></p>
			<a id="modalMap" href="#" target="_blank"
				class="text-blue-600 dark:text-blue-400 hover:underline mb-4 inline-block"></a>

			<!-- Pics Grid -->
			<!-- <div id="modalPics" class="grid grid-cols-2 gap-4"></div> -->
			 <!-- Slideshow Container -->
			<div id="modalPics" class="relative w-full h-64 overflow-hidden rounded-lg shadow-lg bg-gray-100 dark:bg-gray-700">
				<!-- Slides will be injected dynamically -->
			</div>

			<!-- Navigation buttons -->
			<button id="prevBtn" 
					class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 z-10">
				&#10094;
			</button>
			<button id="nextBtn" 
					class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 z-10">
				&#10095;
			</button>
		</div>
	</div>

	<!-- Scripts -->
	<script>
		// Modal functions
		
		let slideIndex = 0;
		let slideInterval;

		function renderSlideshow(pics) {
			const container = document.getElementById("modalPics");
			container.innerHTML = ""; // reset

			// Create slides
			pics.forEach((url, idx) => {
				const img = document.createElement("img");
				img.src = url;
				img.className = "absolute inset-0 w-full h-full object-cover transition-opacity duration-700";
				img.style.opacity = idx === 0 ? "1" : "0"; // first visible
				container.appendChild(img);
			});

			slideIndex = 0;
			startSlideshow();
		}

		function showSlide(index) {
			const slides = document.querySelectorAll("#modalPics img");
			if (!slides.length) return;

			slides.forEach((img, i) => {
				img.style.opacity = i === index ? "1" : "0";
			});
		}

		function startSlideshow() {
			clearInterval(slideInterval);
			slideInterval = setInterval(() => {
				const slides = document.querySelectorAll("#modalPics img");
				slideIndex = (slideIndex + 1) % slides.length;
				showSlide(slideIndex);
			}, 3000); // 3 seconds
		}

		// Navigation buttons
		document.getElementById("prevBtn").addEventListener("click", () => {
			const slides = document.querySelectorAll("#modalPics img");
			slideIndex = (slideIndex - 1 + slides.length) % slides.length;
			showSlide(slideIndex);
		});

		document.getElementById("nextBtn").addEventListener("click", () => {
			const slides = document.querySelectorAll("#modalPics img");
			slideIndex = (slideIndex + 1) % slides.length;
			showSlide(slideIndex);
		});

		function openModal(roadId, name, rating, comment, date, gps) {
			document.getElementById('modalTitle').textContent = name;
			document.getElementById('modalRating').textContent = "‚≠ê Rating: " + rating;
			document.getElementById('modalComment').innerHTML = "<b>Comment:</b> " + comment;
			document.getElementById('modalDate').textContent = "Rated at: " + date;

			let mapLink = document.getElementById('modalMap');
			if (gps && gps !== "None") {
				mapLink.href = generateMapLink(gps);
				mapLink.textContent = "üìç View on Map";
			} else {
				mapLink.textContent = "No GPS coordinates available";
				mapLink.href = "#";
			}
			
			fetch(`/get-presigned-urls/${roadId}/`)
				.then(response => response.json())
				.then(data => {
					if (data.urls && data.urls.length > 0) {
						renderSlideshow(data.urls);
						document.getElementById("prevBtn").style.display = "block";
						document.getElementById("nextBtn").style.display = "block";
					} else {
						const container = document.getElementById("modalPics");
						container.innerHTML = "<p class='text-gray-400 italic p-4'>No images uploaded.</p>";
						document.getElementById("prevBtn").style.display = "none";
						document.getElementById("nextBtn").style.display = "none";
					}
				})
				.catch(err => {
					console.error("Error loading images:", err);
					const container = document.getElementById("modalPics");
					container.innerHTML = "<p class='text-red-500 italic p-4'>Failed to load images.</p>";
					document.getElementById("prevBtn").style.display = "none";
					document.getElementById("nextBtn").style.display = "none";
				});

			/*let picsContainer = document.getElementById('modalPics');
			picsContainer.innerHTML = "<p class='text-gray-500'>Loading images...</p>";

			// üî• Fetch presigned URLs dynamically
			fetch(`/get-presigned-urls/${roadId}/`)
				.then(response => response.json())
				.then(data => {
					picsContainer.innerHTML = "";
					if (data.urls && data.urls.length > 0) {
						data.urls.forEach(url => {
							let img = document.createElement("img");
							img.src = url;
							img.className = "rounded-lg shadow m-2 w-32 h-32 object-cover";
							picsContainer.appendChild(img);
						});
					} else {
						picsContainer.innerHTML = "<p class='text-gray-400 italic'>No images uploaded.</p>";
					}
				})
				.catch(err => {
					console.error("Error loading images:", err);
					picsContainer.innerHTML = "<p class='text-red-500 italic'>Failed to load images.</p>";
				});*/

			document.getElementById('detailsModal').classList.remove("hidden");
			document.getElementById('detailsModal').classList.add("flex");
		}


		function closeModal() {
			document.getElementById('detailsModal').classList.add("hidden");
			document.getElementById('detailsModal').classList.remove("flex");
		}

		// Dark Mode Toggle
		function toggleDarkMode() {
			document.documentElement.classList.toggle('dark');
			// Save preference in localStorage
			if (document.documentElement.classList.contains('dark')) {
				localStorage.setItem('theme', 'dark');
			} else {
				localStorage.setItem('theme', 'light');
			}
		}

		// Load saved preference
		if (localStorage.getItem('theme') === 'dark') {
			document.documentElement.classList.add('dark');
		} else {
			document.documentElement.classList.remove('dark');
		}

		// Close modal with ESC
		document.addEventListener("keydown", function (e) {
			if (e.key === "Escape") closeModal();
		});
	</script>

</body>

</html>